<!DOCTYPE HTML>
<html>
<head>
<link rel="stylesheet" type="text/css" href="page.css" />
<link href='http://fonts.googleapis.com/css?family=Sonsie+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Autour+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quintessential' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Alegreya' rel='stylesheet' type='text/css'>
    <meta charset="utf-8">
	
    <script src="ndn.js"></script>
    <script src="Sync.js"></script>
    <script src="digest_tree.js"></script>
    <script src="Chat.js"></script>
    <script src="prefix.js"></script>
    <script src="Long.min.js"></script>
    <script src="ByteBuffer.min.js"></script>
    <script src="ProtoBuf.noparse.min.js"></script>
    <script src="chatbuf.js"></script>
    <script src="sync_state.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>

var usrname;
var screen_name;
var session;
var chat;
var chatroom;
var sync;
var ndn;
var mykey;
var mykeyname;
var chat_prefix;
var sync_prefix='/ndn/broadcast/ChronoChat-0.3/';
var ProtoBuf = dcodeIO.ProtoBuf;
var ChatMessage = SyncDemo.ChatMessage;
var SyncState = Sync.SyncState;
var SyncStateMsg = Sync.SyncStateMsg;
var prefix_name;
var sync_lifetime = 5000;
var specialnode ='/d0n0t18ak/t0ps8cr8t';

$(document).ready(function(){
    $("#txt").hide();
    $("#fname").hide();
    $("#bottom").hide();
    $("#menu").hide();
    $("#login").click(function(){
        screen_name = document.getElementById('name').value;
	session = (new Date()).getTime();
	session = parseInt(session/1000);
        usrname = screen_name+session;
        chatroom = document.getElementById('chatroom').value;
        if(screen_name==""||chatroom==""){
            alert("input usrname and chatroom");
        }
        else{
            alert(screen_name+", welcome to chatroom "+chatroom+"!");
            $("#log").hide();
            $("#login").hide();
            $("#txt").show();
    	    $("#fname").show();
    	    $("#bottom").show();
            $("#menu").show();
	    document.getElementById('room').innerHTML = '<grey>Chatroom: </grey>'+'<b><green>'+chatroom+'</green></b>';
	    document.getElementById('room').innerHTML+= '<grey>  Username: </grey>'+'<b><green>'+screen_name+'</green></b>';
            document.getElementById('menu').innerHTML = '<p><b>Member</b></p>';
            ChronoChat();
        }
    });

});


function ChronoChat () {
    prefix_name = getRandomString();
    chat = new Chat();
    sync = new ChronoSync(chat.sendInterest.bind(chat),chat.initial.bind(chat),chatroom,session);
    sync.digest_log.push({digest:"00",data:[]});
    ndn = new NDN()//{host:'B.ws.ndn.ucla.edu'});
    mykey = ndn.getDefaultKey();
    mykeyname= new Name('/ndn/'+screen_name+'/'+'ChronoChat-0.3/'+chatroom+'/key/').appendKeyID(mykey).appendVersion().appendSegment(0);

    ndn.onopen = function () {
        var n0 = new Name('/local/ndn/prefix');
	var template = new Interest();
        template.interestLifetime = 1000;
        template.childSelector = 1;
        template.answerOriginKind = 0;
        ndn.expressInterest(n0, template, prefixData, prefixTimeOut);

    };
    ndn.connect();
    
    console.log('Started...');
    
}

function checkkey(event){
    if(event.keyCode==13){
	chat.SendMessage();
    }
}
    </script>

</head>



<body>


<div id = "title" class="center">
<h1><blue>Web</blue> ChronoChat</h1>
<div id = "footer">
      <grey>Powered by </grey><a target="_blank" href="http://github.com/named-data/ndn-js"><blue>NDN.JS</blue></a><grey>.</grey>

</div>
</div>
<div id = "log" class="center">
<div id = "info">
     username: <input type="text" id="name" value="Enter Name">
<br /><br />
     chatroom: <input type="text" id="chatroom" value="ndnchat">
</div>
<button id = "login" > login </button>
</div>

<div style="width:850px" class="center">
<div style="width:850px">
<div id="room"></div>
</div>
<div style="width:850px">
<div id = "txt"></div>
<div id="menu">
</div>
<div>
  <textarea id="fname" onkeyup="checkkey(event)"></textarea>
</div>

<div id = "bottom">
<div id="note"><grey>Press Enter to Send Message</grey></div>
<button id = "send" onclick="chat.SendMessage()"><b>send</b></button>
<button id = "leave" onclick = "chat.Leave()"><blue><b>leave</b></blue></button>
</div>

</div>
</div>
</html>
