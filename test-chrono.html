<!DOCTYPE HTML>
<html>
<head>
    <meta charset="utf-8">
	
    <script src="../ChronoChat-javascript/ndn.js"></script>
    <script src="../ChronoChat-javascript/digestlog.js"></script>
    <script src="../ChronoChat-javascript/digest_tree.js"></script>
    <script src="../ChronoChat-javascript/chatmsg.js"></script>
    <script src="../ChronoChat-javascript/timeout.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script>
var maxmsgcachelength = 100;
var usrdigest = {};
var usrname;
var usrseq = -1;
var max_wait = 10;
var roster = new Array();
var db;
var chatroom;
var msgcache = [];
var digest_tree;
var leaveflag = 0;
var ndn;
var mykey;
var mykeyname;
//var logseq = 1;
var a = 0;
var digest_log = [];

$(document).ready(function(){
    $("#txt").hide();
    $("#fname").hide();
    $("#send").hide();
    $("#leave").hide();
    $("#menu").hide();
    $("#login").click(function(){
        usrname = document.getElementById('name').value;
        chatroom = document.getElementById('chatroom').value;
        if(usrname==""||chatroom==""){
            alert("input usrname and chatroom");
        }
        else{
            alert(usrname+", welcome to chatroom "+chatroom+"!");
            $("#log").hide();
            $("#login").hide();
            $("#txt").show();
    	    $("#fname").show();
    	    $("#send").show();
    	    $("#leave").show();
            $("#menu").show();
            testPublish();
        }
    });
});


function testPublish () {
   
    //roster[0] = {"name":usrname,"chat_count":0};
    /*window.indexedDB.deleteDatabase(dbName);
    var request = window.indexedDB.open(dbName);
    request.onerror = function(event){
	console.log('database open error');
    };
    request.onupgradeneeded = function(event){
	var db0 = event.target.result;
	var objectStore = db0.createObjectStore(usrname,{keyPath:"key"});
	objectStore.createIndex("digest","digest",{unique:true});
	objectStore.createIndex("data","data",{unique:false});
	objectStore.add({key:0,digest:"",data:[]});////////////////////
    };*/
    digest_log.push({digest:"0000",data:[]});
    digest_tree = new Digest_Tree();
    ndn = new NDN();
    mykey = ndn.getDefaultKey();
    mykeyname= new Name('/ndn/'+usrname+'/'+'chronos/'+chatroom+'/key/').appendKeyID(mykey).appendVersion().appendSegment(0);

    ndn.onopen = function () {
        msgcache.push({seqno:0,msgtype:"join",msg:"xxx"});
        var n1 = new Name('/ndn/broadcast/chronos/'+chatroom+'/');
        ndn.registerPrefix(n1,onSyncInterest);
        console.log('sync prefix registered.');
        var n2 = new Name('/ndn/ucla.edu/irl/'+usrname+'/'+chatroom+'/');
        ndn.registerPrefix(n2,onChatInterest);
        console.log('data prefix registered.');
        var n = new Name('/ndn/broadcast/chronos/'+chatroom+'/').append(DataUtils.toNumbers('0000'));
        var template = new Interest();
        //template.answerOriginKind = Interest.ANSWER_NO_CONTENT_STORE;
        template.interestLifetime = 1000;
        ndn.expressInterest(n, template, onSyncData, initial_timeout);
        console.log("initial sync express");
     
    };

    
    ndn.connect();
    
    console.log('Started...');
    /*request.onsuccess = function(event){
	db = request.result;
	console.log("open database");
        digest_tree = new Digest_Tree();
        ndn = new NDN();
        mykey = ndn.getDefaultKey();
        mykeyname= new Name('/ndn/'+usrname+'/'+'chronos/'+chatroom+'/key/').appendKeyID(mykey).appendVersion().appendSegment(0);

        ndn.onopen = function () {
            msgcache.push({seqno:0,msgtype:"join",msg:"xxx"});
            var n1 = new Name('/ndn/broadcast/chronos/'+chatroom+'/');
            ndn.registerPrefix(n1,onSyncInterest);
            console.log('sync prefix registered.');
            var n2 = new Name('/ndn/ucla.edu/irl/'+usrname+'/'+chatroom+'/');
            ndn.registerPrefix(n2,onChatInterest);
            console.log('data prefix registered.');
            var n = new Name('/ndn/broadcast/chronos/'+chatroom+'/');
            var template = new Interest();
            //template.answerOriginKind = Interest.ANSWER_NO_CONTENT_STORE;
            template.interestLifetime = 1000;
            ndn.expressInterest(n, template, onSyncData, initial_timeout);
        
        };

    
        ndn.connect();
    
        console.log('Started...');
    };
    //InitialLog(usrname);*/
    
}

    </script>
<style>
h1{text-align:center;}
button{text-align:center;}
div{text-align:center;}
.center
{
margin:auto;
}
</style>
</head>



<body>


<div id = "title" style = "width:700px" class="center">
<h1 style="margin-bottom:0;">Web ChronoChat</h1></div>


<div id = "log" style="width:700px" class="center">
username:<input type="text" id="name"
style="width:100px;height:20px;font-size:15px" value="qiuhan" autocomplete="on">
<br /><br />
chatroom:<input type="text" id="chatroom"
style="width:100px;height:20px;font-size:15px" value="qiu" autocomplete="on">
<br /><br />
<button id = "login" > login </button>
</div>

<div style="width:710px" class="center">
  
<div id="menu" style="height:600px;width:100px;float:left;">
<b>Member</b><br>
</div>
<div id = "txt" style="border-style:solid;border-width:2px;overflow:auto;width:600px;height:300px;font-size:20px;float:left;"></div>

<div>
  <textarea id="fname" style="width:600px;height:100px;font-size:10px;float:left;margin-top:10px;margin-bottom:10px"></textarea>
</div>

<div>
<button id = "send" style="font-size:20px;float:left" onclick="SendMessage()">send</button>
<button id = "leave" style="font-size:20px;float:left;" onclick="Leave()">leave</button>
</div>

</div>


</body>
</html>
