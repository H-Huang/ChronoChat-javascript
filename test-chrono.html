<!DOCTYPE HTML>
<html>
<head>
<link rel="stylesheet" type="text/css" href="page.css" />
<link href='http://fonts.googleapis.com/css?family=Sonsie+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Autour+One' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Architects+Daughter' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Quintessential' rel='stylesheet' type='text/css'>
<link href='http://fonts.googleapis.com/css?family=Alegreya' rel='stylesheet' type='text/css'>
    <meta charset="utf-8">
	
    <script src="../ChronoChat-javascript/ndn.js"></script>
    <script src="../ChronoChat-javascript/Sync.js"></script>
    <script src="../ChronoChat-javascript/digest_tree.js"></script>
    <script src="../ChronoChat-javascript/Chat.js"></script>
    <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>

    <script>

var usrname;
var screen_name;
//var usrseq = -1;
var chat;
var chatroom;
var sync;
var ndn;
var mykey;
var mykeyname;

$(document).ready(function(){
    $("#txt").hide();
    $("#fname").hide();
    $("#bottom").hide();
    $("#menu").hide();
    $("#login").click(function(){
        screen_name = document.getElementById('name').value;
        usrname = screen_name+(new Date()).getTime();
        chatroom = document.getElementById('chatroom').value;
        if(screen_name==""||chatroom==""){
            alert("input usrname and chatroom");
        }
        else{
            alert(screen_name+", welcome to chatroom "+chatroom+"!");
            $("#log").hide();
            $("#login").hide();
            $("#txt").show();
    	    $("#fname").show();
    	    $("#bottom").show();
            $("#menu").show();
	    document.getElementById('room').innerHTML = '<grey>Chatroom: </grey>'+'<b><green>'+chatroom+'</green></b>';
	    document.getElementById('room').innerHTML+= '<grey>  Username: </grey>'+'<b><green>'+screen_name+'</green></b>';
            document.getElementById('menu').innerHTML = '<p><b>Member</b></p>';
            testPublish();
        }
    });
});


function testPublish () {
    chat = new Chat();
    sync = new Sync(chat.sendInterest.bind(chat),chat.initial.bind(chat));
    sync.digest_log.push({digest:"0000",data:[]});
    ndn = new NDN();
    mykey = ndn.getDefaultKey();
    mykeyname= new Name('/ndn/'+screen_name+'/'+'chronos/'+chatroom+'/key/').appendKeyID(mykey).appendVersion().appendSegment(0);

    ndn.onopen = function () {
        /*var d = new Date();
	var t = d.getTime();
        msgcache.push({seqno:0,msgtype:"join",msg:"xxx",time:t});*/
        //initialchat();
        var n1 = new Name('/ndn/broadcast/chronos/'+chatroom+'/');
        ndn.registerPrefix(n1,sync.onInterest.bind(sync));
        console.log('sync prefix registered.');
        var n2 = new Name('/ndn/ucla.edu/irl/'+screen_name+'/'+chatroom+'/');
        ndn.registerPrefix(n2,chat.onInterest.bind(chat));
        console.log('data prefix registered.');
        var n = new Name('/ndn/broadcast/chronos/'+chatroom+'/').append(DataUtils.toNumbers('0000'));
        var template = new Interest();
        template.interestLifetime = 1000;
        template.answerOriginKind = Interest.ANSWER_NO_CONTENT_STORE;
        ndn.expressInterest(n, template, sync.onData.bind(sync), sync.initialTimeOut.bind(sync));
        console.log("initial sync express");
        console.log(n.to_uri());
     
    };

    
    ndn.connect();
    
    console.log('Started...');
    
}

function checkkey(event){
    if(event.keyCode==13){
	chat.SendMessage();
    }
}
    </script>

</head>



<body>


<div id = "title" class="center">
<h1><blue>Web</blue> ChronoChat</h1>
<div id = "footer">
      <grey>Powered by </grey><a target="_blank" href="http://github.com/named-data/ndn-js"><blue>NDN.JS</blue></a><grey>.</grey>

</div>
</div>
<div id = "log" class="center">
<div id = "info">
     username: <input type="text" id="name" value="qiuhan">
<br /><br />
     chatroom: <input type="text" id="chatroom" value="ndnchat">
</div>
<button id = "login" > login </button>
</div>

<div style="width:850px" class="center">
<div style="width:850px">
<div id="room"></div>
</div>
<div style="width:850px">
<div id = "txt"></div>
<div id="menu">
</div>
<div>
  <textarea id="fname" onkeyup="checkkey(event)"></textarea>
</div>

<div id = "bottom">
<div id="note"><grey>Press Enter to Send Message</grey></div>
<button id = "send" onclick="chat.SendMessage()"><b>send</b></button>
<button id = "leave" onclick="chat.Leave()"><blue><b>leave</b></blue></button>
</div>

</div>
</div>
</html>
